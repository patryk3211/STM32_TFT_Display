#include <Arduino.h>

#include "lcd/tft_driver.h"
#include "lcd/fonts/freesans9pt7b.h"
#include "lcd/fonts/freesans12pt7b.h"
#include "lcd/fonts/freemonobold12pt7b.h"

#include "lcd/gfx.h"

#define LIGHT_BLUE TFT_COLOR(15, 15, 31)
#define DARK_GRAY TFT_COLOR(4, 4, 4)

const GuiElement header_children[] = {
    GUI_TEXT(6, 2, TFT_WHITE, "CNC Controller v1.0.0", FreeSans12pt7b)
};

GuiElement position_box_children[] = {
    GUI_BORDER(-1, -1, PARENT_WIDTH(1), PARENT_HEIGHT(1), TFT_CYAN, 1),

    GUI_TEXT(4, 4, TFT_WHITE, "Position", FreeSans12pt7b),
    GUI_TEXT_RIGHT(PARENT_WIDTH(-4), 4, TFT_WHITE, "[mm]", FreeSans12pt7b),

    GUI_TEXT(8, 8 + 24 * 1, TFT_RED,   "X: 000.00 000.00", FreeMonoBold12pt7b),
    GUI_TEXT(8, 8 + 24 * 2, TFT_GREEN, "Y: 000.00 000.00", FreeMonoBold12pt7b),
    GUI_TEXT(8, 8 + 24 * 3, TFT_BLUE,  "Z: 000.00 000.00", FreeMonoBold12pt7b)
};

GuiElement control_box_children[] = {
    GUI_BORDER(-1, -1, PARENT_WIDTH(1), PARENT_HEIGHT(1), TFT_YELLOW, 1),

    GUI_TEXT(4, 4, DARK_GRAY, "Step: 1.00mm", FreeSans9pt7b),
    GUI_TEXT_RIGHT(PARENT_WIDTH(-4), 4, DARK_GRAY, "Feed: 100mm/s", FreeSans9pt7b)
};

const GuiElement me_children[] = {
    GUI_BOX_STATIC(0, 0, PARENT_WIDTH(0), 32, TFT_BLUE, header_children),

    GUI_BOX_STATIC(16, 48, PARENT_WIDTH(-32), 112, TFT_BLACK, position_box_children),
    GUI_BOX_STATIC(16, 176, PARENT_WIDTH(-32), 120, TFT_BLACK, control_box_children),

    GUI_BUTTON( 16, 440, 80, 24, TFT_BLUE, TFT_WHITE, "[Zero]", FreeSans9pt7b, 0),
    GUI_BUTTON(120, 440, 80, 24, TFT_BLUE, TFT_WHITE, "[Menu]", FreeSans9pt7b, 0),
    GUI_BUTTON(224, 440, 80, 24, TFT_BLUE, TFT_WHITE, "[Home]", FreeSans9pt7b, 0)
};

const GuiElement main_element = GUI_BOX_STATIC(0, 0, 320, 480, TFT_BLACK, me_children);

const uint8_t bitmap[] = {0xff, 17, 0x0, 0x1f, 0xff, 3, 0xff, 0xf8, 0x1f, 0xff, 3, 0xff, 0xf8, 0x1f, 0xff, 3, 0xff, 0xf8, 0x1c, 0xff, 3, 0x0, 0x38, 0x1c, 0xff, 3, 0x0, 0x38, 0x1c, 0xff, 3, 0x0, 0x38, 0x1c, 0x0, 0x7, 0xe0, 0x0, 0x38, 0x1c, 0x0, 0x7, 0xe0, 0x0, 0x38, 0x1c, 0x0, 0x7, 0xe0, 0x0, 0x38, 0x1c, 0x0, 0x3f, 0xfc, 0x0, 0x38, 0x1c, 0x0, 0x3f, 0xfc, 0x0, 0x38, 0x1c, 0x0, 0x3f, 0xfc, 0x0, 0x38, 0x1c, 0x1, 0xff, 1, 0xff, 0x80, 0x38, 0x1c, 0x1, 0xff, 1, 0xff, 0x80, 0x38, 0x1c, 0x1, 0xff, 1, 0xff, 0x80, 0x38, 0x1c, 0xf, 0xff, 1, 0xff, 0xf0, 0x38, 0x1c, 0xf, 0xff, 1, 0xff, 0xf0, 0x38, 0x1c, 0xf, 0xff, 1, 0xff, 0xf0, 0x38, 0x1c, 0xf, 0xff, 1, 0xff, 0xf0, 0x38, 0x1c, 0xf, 0xff, 1, 0xff, 0xf0, 0x38, 0x1c, 0xf, 0xff, 1, 0xff, 0xf0, 0x38, 0x1c, 0x0, 0x7, 0xe0, 0x0, 0x38, 0x1c, 0x0, 0x7, 0xe0, 0x0, 0x38, 0x1c, 0x0, 0x7, 0xe0, 0x0, 0x38, 0x1c, 0x0, 0x7, 0xe0, 0x0, 0x38, 0x1c, 0x0, 0x7, 0xe0, 0x0, 0x38, 0x1c, 0x0, 0x7, 0xe0, 0x0, 0x38, 0x1c, 0x0, 0x7, 0xe0, 0x0, 0x38, 0x1c, 0x0, 0x7, 0xe0, 0x0, 0x38, 0x1c, 0x0, 0x7, 0xe0, 0x0, 0x38, 0x1c, 0x0, 0x7, 0xe0, 0x0, 0x38, 0x1c, 0x0, 0x7, 0xe0, 0x0, 0x38, 0x1c, 0x0, 0x7, 0xe0, 0x0, 0x38, 0x1c, 0x0, 0x7, 0xe0, 0x0, 0x38, 0x1c, 0x0, 0x7, 0xe0, 0x0, 0x38, 0x1c, 0x0, 0x7, 0xe0, 0x0, 0x38, 0x1c, 0xff, 3, 0x0, 0x38, 0x1c, 0xff, 3, 0x0, 0x38, 0x1c, 0xff, 3, 0x0, 0x38, 0x1f, 0xff, 3, 0xff, 0xf8, 0x1f, 0xff, 3, 0xff, 0xf8, 0x1f, 0xff, 3, 0xff, 0xf8, 0xff, 17, 0x0 };

void setup() {
    Serial.begin(9600);

    tft_driver_init();

//    auto result = gfx_create_render_chain(&main_element, 1);
//    tft_submit_multiple(result.grc_operations, result.grc_length);
//
//    gfx_activate_event_list(result.grc_eventList);

    auto* op = tft_new_operation(RLE_BITMAP);
    op->lo_fg = TFT_WHITE;
    op->lo_bg = TFT_BLACK;
    op->lo_x = 20;
    op->lo_y = 20;
    op->lo_bitmap.width = 48;
    op->lo_bitmap.height = 48;
    op->lo_bitmap.scale = 2;
    op->lo_bitmap.bitmap = bitmap;
    tft_submit(op);

    tft_start_render();

    attachInterrupt(PB12, &tft_tp_irq, FALLING);
}

void loop() {
    tft_main_loop();
}
